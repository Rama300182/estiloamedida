<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estilo a Medida | Tu hogar, tu estilo</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/comodas.css">
  <link rel="stylesheet" href="css/placards.css">
  <link rel="stylesheet" href="css/racks.css">
  <link rel="stylesheet" href="css/detalle-producto.css">
  <link rel="stylesheet" href="css/whatsapp-float.css">
  <link rel="stylesheet" href="css/newsletter.css">
  <link rel="icon" type="image/png" href="image/logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Supabase JS (usando jsdelivr por ser más confiable que unpkg) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <!-- Scripts de la aplicación en orden -->
  <script src="config/supabase.js" defer></script>
  <script src="js/products.service.js" defer></script>
  <script src="js/leads.service.js" defer></script>
  <script src="js/newsletter.js" defer></script>
  <script src="js/placards.js" defer></script>
  <script src="js/racks.js" defer></script>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">
          <a href="index.html">
            <img src="image/logo.png" alt="Estilo a Medida Logo">
          </a>
        </div>
        <div class="nav-links">
          <a href="index.html#inicio">Inicio</a>
          <a href="index.html#categorias">Categorías</a>
          <a href="index.html#proyectos">Proyectos</a>
          <a href="contacto.html">Contacto</a>
        </div>
        <a href="https://www.instagram.com/estilo.a.medida" target="_blank" class="social-icon">
          <i class="fab fa-instagram"></i>
        </a>
      </nav>
    </div>
  </header>

<main class="detalle-producto">
    <!-- Loading State -->
    <div id="loading-estado" class="loading-container">
        <div class="loading-spinner">
            <div class="loading-bar"></div>
            <div class="loading-text">Cargando detalles del producto...</div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-estado" class="error-container" style="display: none;">
        <div class="error-message">
            <h2>❌ Error</h2>
            <p id="error-mensaje">No se pudo cargar el producto</p>
            <a href="comodas.html" class="btn-primary">← Volver a Cómodas</a>
        </div>
    </div>

    <!-- Producto Content -->
    <div id="producto-contenido" style="display: none;">
        <div class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb">
                <a href="index.html">Inicio</a> > 
                <a href="comodas.html">Cómodas</a> > 
                <span id="breadcrumb-producto">Producto</span>
            </nav>

            <!-- Hero del Producto -->
            <section class="producto-hero">
                <div class="producto-galeria">
                    <div class="imagen-principal">
                        <img id="imagen-principal" src="" alt="Producto">
                        <div class="imagen-navegacion">
                            <button id="prev-imagen" class="nav-btn">❮</button>
                            <button id="next-imagen" class="nav-btn">❯</button>
                        </div>
                    </div>
                    <div class="imagenes-thumbnails" id="thumbnails-container">
                        <!-- Thumbnails se generan dinámicamente -->
                    </div>
                </div>

                <div class="producto-info">
                    <div class="categoria-badge" id="categoria-badge">Categoría</div>
                    <h1 id="producto-nombre">Nombre del Producto</h1>

                    <div class="precio-container" id="precio-container" style="display: none;">
                        <div class="precio-valor" id="precio-valor">$—</div>
                    </div>
                    
                    <p class="producto-slogan" id="producto-slogan">Slogan del producto</p>
                    
                    <div class="producto-especificaciones" id="especificaciones-container">
                        <div class="especificaciones-titulo">Especificaciones</div>
                        <div class="especificaciones-grid">
                            <div class="especificacion">
                                <span class="especificacion-label">Ancho</span>
                                <span class="especificacion-valor" id="dimension-ancho">—</span>
                            </div>
                            <div class="especificacion">
                                <span class="especificacion-label">Alto</span>
                                <span class="especificacion-valor" id="dimension-alto">—</span>
                            </div>
                            <div class="especificacion">
                                <span class="especificacion-label">Profundidad</span>
                                <span class="especificacion-valor" id="dimension-profundidad">—</span>
                            </div>
                        </div>
                    </div>

                    <div class="acciones-producto">
                        <button class="btn-principal" onclick="contactarProducto()">
                            Solicitar información
                        </button>
                        <a href="comodas.html" class="btn-secundario">
                            Ver catálogo completo
                        </a>
                    </div>
                </div>
            </section>

            <!-- Contenido adicional -->
            <div class="producto-contenido">
                <!-- Descripción -->
                <section class="seccion">
                    <h2 class="seccion-titulo">Descripción</h2>
                    <div id="producto-descripcion-texto" class="descripcion-texto">
                        <!-- Se llena dinámicamente -->
                    </div>
                </section>

                <!-- Características -->
                <section class="seccion" id="caracteristicas-section" style="display: none;">
                    <h2 class="seccion-titulo">Características destacadas</h2>
                    <ul id="caracteristicas-lista" class="caracteristicas-lista">
                        <!-- Se llena dinámicamente -->
                    </ul>
                </section>

                <!-- Call to Action Final -->
                <section class="cta-final">
                    <h3 class="cta-titulo">¿Necesitas más información?</h3>
                    <p class="cta-descripcion">
                        Contáctanos para recibir asesoramiento personalizado, 
                        presupuestos detallados y opciones de personalización.
                    </p>
                    <div class="cta-acciones">
                        <button class="btn-principal" onclick="contactarProducto()">
                            Contactar ahora
                        </button>
                        <button class="btn-secundario" onclick="compartirProducto()">
                            Compartir producto
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>
</main>

<script>
let productoActual = null;
let imagenesProducto = [];
let imagenActualIndex = 0;

// Cargar producto cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    // Obtener el ID del producto desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const productoId = urlParams.get('id');
    
    if (!productoId) {
        // Si no hay ID, redirigir a la página principal
        window.location.href = 'index.html';
        return;
    }
    
    cargarProducto(parseInt(productoId));
});

async function cargarProducto(id) {
    try {
        // Mostrar loading
        mostrarEstado('loading');
        
        // Esperar a que ProductsService esté disponible
        await esperarServicio('ProductsService');
        
        const resultado = await window.ProductsService.getProductoById(id);
        
        if (!resultado.success) {
            throw new Error(resultado.error || 'Error desconocido');
        }
        
        if (!resultado.data) {
            throw new Error('Producto no encontrado');
        }
        
        productoActual = resultado.data;
        mostrarProducto(resultado.data);
        mostrarEstado('success');
        
    } catch (error) {
        console.error('Error cargando producto:', error);
        mostrarError(error.message);
    }
}

function mostrarEstado(estado) {
    const loading = document.getElementById('loading-estado');
    const error = document.getElementById('error-estado');
    const contenido = document.getElementById('producto-contenido');
    
    loading.style.display = estado === 'loading' ? 'block' : 'none';
    error.style.display = estado === 'error' ? 'block' : 'none';
    contenido.style.display = estado === 'success' ? 'block' : 'none';
}

function mostrarError(mensaje) {
    document.getElementById('error-mensaje').textContent = mensaje;
    mostrarEstado('error');
}

function mostrarProducto(producto) {
    // Título y breadcrumb
    document.title = `${producto.nombre} | Estilo a Medida`;
    document.getElementById('breadcrumb-producto').textContent = producto.nombre;
    
    // Información básica
    document.getElementById('categoria-badge').textContent = producto.categorias?.nombre || 'Producto';
    document.getElementById('producto-nombre').textContent = producto.nombre;
    document.getElementById('producto-slogan').textContent = producto.descripcion_corta || '';
    
    // Descripción
    document.getElementById('producto-descripcion-texto').textContent = producto.descripcion_larga || producto.descripcion_corta || 'Sin descripción disponible.';
    
    // Dimensiones
    if (producto.ancho_cm || producto.alto_cm || producto.profundidad_cm) {
        document.getElementById('dimension-ancho').textContent = producto.ancho_cm ? `${producto.ancho_cm} cm` : '-';
        document.getElementById('dimension-alto').textContent = producto.alto_cm ? `${producto.alto_cm} cm` : '-';
        document.getElementById('dimension-profundidad').textContent = producto.profundidad_cm ? `${producto.profundidad_cm} cm` : '-';
    }
    
    // Precio
    if (producto.precio_desde && producto.precio_desde > 0) {
        document.getElementById('precio-valor').textContent = `$${producto.precio_desde.toLocaleString()}`;
        document.getElementById('precio-container').style.display = 'block';
    }
    
    // Galería de imágenes
    configurarGaleria(producto);
    
    // Features
    mostrarFeatures(producto.producto_features || []);
}

function configurarGaleria(producto) {
    imagenesProducto = [];
    
    // Primero, añadir imágenes adicionales desde producto_fotos
    if (producto.producto_fotos && producto.producto_fotos.length > 0) {
        producto.producto_fotos
            .sort((a, b) => (a.orden || 0) - (b.orden || 0))
            .forEach(foto => {
                imagenesProducto.push({
                    url: foto.url,
                    alt: foto.alt || producto.nombre
                });
            });
    }
    
    // Solo añadir imagen principal si no hay fotos adicionales o si no está ya incluida
    if (producto.imagen_url) {
        const yaExiste = imagenesProducto.some(img => img.url === producto.imagen_url);
        if (!yaExiste) {
            // Añadir al principio si no existe
            imagenesProducto.unshift({
                url: producto.imagen_url,
                alt: producto.nombre
            });
        }
    }
    
    // Si no hay imágenes en producto_fotos, usar la imagen principal
    if (imagenesProducto.length === 0 && producto.imagen_url) {
        imagenesProducto.push({
            url: producto.imagen_url,
            alt: producto.nombre
        });
    }
    
    if (imagenesProducto.length > 0) {
        imagenActualIndex = 0;
        mostrarImagenPrincipal();
        generarThumbnails();
        configurarNavegacionImagenes();
    }
}

function mostrarImagenPrincipal() {
    if (imagenesProducto.length > imagenActualIndex) {
        const imagen = imagenesProducto[imagenActualIndex];
        const imgElement = document.getElementById('imagen-principal');
        imgElement.src = imagen.url;
        imgElement.alt = imagen.alt;
        
        // Actualizar thumbnails activos
        document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
            thumb.classList.toggle('active', index === imagenActualIndex);
        });
    }
}

function generarThumbnails() {
    const container = document.getElementById('thumbnails-container');
    container.innerHTML = '';
    
    imagenesProducto.forEach((imagen, index) => {
        const thumb = document.createElement('img');
        thumb.src = imagen.url;
        thumb.alt = imagen.alt;
        thumb.className = 'thumbnail';
        if (index === 0) thumb.classList.add('active');
        
        thumb.addEventListener('click', () => {
            imagenActualIndex = index;
            mostrarImagenPrincipal();
        });
        
        container.appendChild(thumb);
    });
    
    // Mostrar navegación solo si hay múltiples imágenes
    const navegacion = document.querySelector('.imagen-navegacion');
    navegacion.style.display = imagenesProducto.length > 1 ? 'flex' : 'none';
}

function configurarNavegacionImagenes() {
    document.getElementById('prev-imagen').addEventListener('click', () => {
        if (imagenActualIndex > 0) {
            imagenActualIndex--;
        } else {
            imagenActualIndex = imagenesProducto.length - 1;
        }
        mostrarImagenPrincipal();
    });
    
    document.getElementById('next-imagen').addEventListener('click', () => {
        if (imagenActualIndex < imagenesProducto.length - 1) {
            imagenActualIndex++;
        } else {
            imagenActualIndex = 0;
        }
        mostrarImagenPrincipal();
    });
}

function mostrarFeatures(features) {
    const featuresSection = document.getElementById('caracteristicas-section');
    const featuresLista = document.getElementById('caracteristicas-lista');
    
    if (features && features.length > 0) {
        featuresLista.innerHTML = '';
        
        features
            .sort((a, b) => (a.orden || 0) - (b.orden || 0))
            .forEach(feature => {
                const li = document.createElement('li');
                li.className = 'caracteristica-item';
                li.textContent = feature.texto;
                featuresLista.appendChild(li);
            });
        
        featuresSection.style.display = 'block';
    } else {
        featuresSection.style.display = 'none';
    }
}

function contactarProducto() {
    if (productoActual) {
        // Redirigir al formulario de contacto con el producto preseleccionado
        window.location.href = `index.html#contacto&producto=${encodeURIComponent(productoActual.nombre)}`;
    }
}

function compartirProducto() {
    if (navigator.share && productoActual) {
        navigator.share({
            title: productoActual.nombre,
            text: productoActual.descripcion_corta || `Mira este producto de Estilo a Medida`,
            url: window.location.href
        });
    } else {
        // Fallback: copiar URL al clipboard
        navigator.clipboard.writeText(window.location.href)
            .then(() => alert('🔗 Enlace copiado al portapapeles'))
            .catch(() => alert('No se pudo copiar el enlace'));
    }
}

// Función auxiliar para esperar a que un servicio esté disponible
async function esperarServicio(nombreServicio, intentosMax = 50) {
    for (let i = 0; i < intentosMax; i++) {
        if (window[nombreServicio] && typeof window[nombreServicio].getProductoById === 'function') {
            return true;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    throw new Error(`Servicio ${nombreServicio} no disponible`);
}
</script>

<footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-col">
          <h4>Estilo a Medida</h4>
          <p>Tu hogar, tu estilo. Creamos muebles a la medida de tus sueños, combinando diseño, funcionalidad y estética.</p>
          <div class="footer-social">
            <a href="https://www.instagram.com/estilo.a.medida" target="_blank" class="social-icon">
              <i class="fab fa-instagram"></i>
            </a>
            <a href="#" class="social-icon">
              <i class="fab fa-facebook-f"></i>
            </a>
            <a href="#" class="social-icon">
              <i class="fab fa-pinterest"></i>
            </a>
          </div>
        </div>
        <div class="footer-col">
          <h4>Enlaces rápidos</h4>
          <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="index.html#categorias">Categorías</a></li>
            <li><a href="index.html#nosotros">Nosotros</a></li>
            <li><a href="index.html#proyectos">Proyectos</a></li>
            <li><a href="contacto.html">Contacto</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h4>Contáctanos</h4>
          <ul>
            <li><i class="fas fa-map-marker-alt"></i> Av. Ejemplo 1234, Santiago</li>
            <li><i class="fas fa-phone"></i> 11-7393-1253</li>
            <li><i class="fas fa-envelope"></i> estiloamedidaideas@gmail.com</li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2025 Estilo a Medida. Todos los derechos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Botón flotante de WhatsApp -->
  <a href="https://wa.me/5491173931253?text=¡Hola! Me interesa conocer más sobre los muebles de Estilo a Medida" 
     class="whatsapp-float" 
     target="_blank"
     aria-label="Contactar por WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>
  
  <script src="js/comoda.js"></script>
  <script src="js/whatsapp.js"></script>
</body>
</html>